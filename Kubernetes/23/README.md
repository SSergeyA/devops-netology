# Sergey Sokolov
## Домашнее задание к занятию 15.4 "Кластеры. Ресурсы под управлением облачных провайдеров"

Организация кластера Kubernetes и кластера баз данных MySQL в отказоустойчивой архитектуре. Размещение в private подсетях кластера БД, а в public - кластера Kubernetes.
### Задание 1. Яндекс.Облако (обязательное к выполнению)

    Настроить с помощью Terraform кластер баз данных MySQL:

    Используя настройки VPC с предыдущих ДЗ, добавить дополнительно подсеть private в разных зонах, чтобы обеспечить отказоустойчивость
    Разместить ноды кластера MySQL в разных подсетях
    Необходимо предусмотреть репликацию с произвольным временем технического обслуживания
    Использовать окружение PRESTABLE, платформу Intel Broadwell с производительностью 50% CPU и размером диска 20 Гб
    Задать время начала резервного копирования - 23:59
    Включить защиту кластера от непреднамеренного удаления
    Создать БД с именем netology_db c логином и паролем

    Настроить с помощью Terraform кластер Kubernetes

    Используя настройки VPC с предыдущих ДЗ, добавить дополнительно 2 подсети public в разных зонах, чтобы обеспечить отказоустойчивость
    Создать отдельный сервис-аккаунт с необходимыми правами
    Создать региональный мастер kubernetes с размещением нод в разных 3 подсетях
    Добавить возможность шифрования ключом из KMS, созданного в предыдущем ДЗ
    Создать группу узлов состояющую из 3 машин с автомасштабированием до 6
    Подключиться к кластеру с помощью kubectl
    *Запустить микросервис phpmyadmin и подключиться к БД, созданной ранее
    *Создать сервис типы Load Balancer и подключиться к phpmyadmin. Предоставить скриншот с публичным адресом и подключением к БД   
    
 [Файл с манифестом для терраформа](https://github.com/SSergeyA/devops-netology/blob/main/Kubernetes/23/main.tf)  
 [Файл c манифестом kubernetes](https://github.com/SSergeyA/devops-netology/blob/main/Kubernetes/23/phpadm.yaml)  
 Создал кластера MySqL и kubernetes 
![image](https://user-images.githubusercontent.com/93119897/221963810-0ec1ec53-d2b8-40b8-858a-04ee9182d164.png)
 Сохранил локально конфиг для подключения к кластеру кубера  
![image](https://user-images.githubusercontent.com/93119897/221964089-4fffac2c-78f1-4b3d-b63a-44f4ed9be5e3.png)
![image](https://user-images.githubusercontent.com/93119897/221964465-9bba49e1-66be-4723-8b11-989bb0b61494.png)
Запустил манифест с подами php my admin  
![image](https://user-images.githubusercontent.com/93119897/221964724-9895a5d0-6716-4701-91b5-c02abb45988d.png)
Подключился к консоли phpMyAdmin через проброс портов и козданной базе
![image](https://user-images.githubusercontent.com/93119897/221965099-c04b910b-1304-40ff-bdef-32f9b9d1feea.png)
#### Проработка вопросов.( которые у меня были ниже):  
1. Балансировщик за работал, я добавил сервисному аккаунту права лоад-балансер.админ и ошибки при создании балансировщика больше нет , все запускается   
![image](https://user-images.githubusercontent.com/93119897/223461992-a4b63f0f-f2a8-415f-941b-2347b7b9320c.png)
![image](https://user-images.githubusercontent.com/93119897/223462071-215cc0ba-e692-4a55-bb97-d5b3c2ebbce1.png)  
![image](https://user-images.githubusercontent.com/93119897/223462280-0e98f9a5-ef77-43c1-bc1a-beb62bea9715.png)  
2. Настроил распределение по зонам, но по заданию у нас на группу нод еще должен быть включено автомасштабирование. А оно в яндекс облаке может работать только в одной зоне доступности. Так, что этот вариант отпадает.  
![image](https://user-images.githubusercontent.com/93119897/223463057-146204dd-9fbf-4228-83e1-8503727a5e14.png)  


### Вопросы:  

1) Балансировщик , я пробовал создавать и в манифесте и отдельно через команду кубктл и через консоль яндекс облака. Всегда возникает ошибка с правами при создании к каталогу.   
Из-за чего она возникает я не могу понять, был бы признателен за пояснение. 
![image](https://user-images.githubusercontent.com/93119897/221965756-6d0638b8-f5d4-4a99-bc2f-80908270a50c.png)  

2) Где можно посмотреть примеры или объяснения, как правильно настраивать группы узлов кластера кубера по разным зонам доступности ? 
Вот в этой части кода? у меня, когда я перечислял разные зоны , все время вываливались ошибки, группа создается только когда и там и там одна зона.
```
network_interface {
      nat                = true
      subnet_ids         = ["${yandex_vpc_subnet.subnet-2a.id}"]
    }
```
```

  allocation_policy {
    location {
        zone      = yandex_vpc_subnet.subnet-2a.zone
      }
  } 
```
